    1: import io
    2: import zipfile
    3: 
    4: import streamlit as st
    5: import pandas as pd
    6: import numpy as np
    7: 
    8: from model_utils import (
    9:     DATA_PATH,
   10:     list_models,
   11:     load_model,
   12:     predict_price,
   13:     train_model_ex,
   14:     load_model_meta,
   15:     delete_models,
   16: )
   17: 
   18: 
   19: st.set_page_config(page_title="CoPiLinear å·¥å…·", layout="wide")
   20: st.title("CoPiLinear æ¨¡å‹å·¥å…·")
   21: 
   22: MENU = st.sidebar.radio("å¯¼èˆª", ["æ¨¡å‹ç®¡ç†", "æ¨¡å‹è®­ç»ƒ", "æ—¥å‰ä»·æ ¼é¢„æµ‹", "æ•°æ®å±•ç¤º", "å…³äº"])
   23: 
   24: 
   25: # ----------------------------------------
   26: # 1) æ¨¡å‹ç®¡ç†
   27: # ----------------------------------------
   28: if MENU == "æ¨¡å‹ç®¡ç†":
   29:     st.subheader("æ¨¡å‹ç®¡ç†")
   30:     models = list_models()
   31:     if not models:
   32:         st.info("æš‚æ— æ¨¡å‹ï¼Œè¯·å…ˆåˆ°â€˜æ¨¡å‹è®­ç»ƒâ€™é¡µåˆ›å»ºæ¨¡å‹ã€?)
   33:     else:
   34:         selected = st.multiselect("é€‰æ‹©æ¨¡å‹ï¼ˆç”¨äºæ‰¹é‡æ“ä½œï¼‰", models)
   35:         col_a, col_b = st.columns(2)
   36:         with col_a:
   37:             if st.button("åˆ é™¤æ‰€é€‰æ¨¡å?):
   38:                 if not selected:
   39:                     st.warning("è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ¨¡å?)
   40:                 else:
   41:                     summary = delete_models(selected)
   42:                     st.success(f"å·²åˆ é™? {', '.join(summary.get('removed', []))}")
   43:                     if summary.get('missing'):
   44:                         st.info(f"æœªæ‰¾åˆ? {', '.join(summary['missing'])}")
   45:         with col_b:
   46:             if st.button("æ‰“åŒ…ä¸‹è½½æ‰€é€‰æ¨¡å?):
   47:                 if not selected:
   48:                     st.warning("è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ¨¡å?)
   49:                 else:
   50:                     buf = io.BytesIO()
   51:                     with zipfile.ZipFile(buf, mode="w", compression=zipfile.ZIP_DEFLATED) as zf:
   52:                         for name in selected:
   53:                             for ext in (".pkl", ".meta.json", ".train.csv"):
   54:                                 path = f"models/{name}{ext}"
   55:                                 try:
   56:                                     with open(path, "rb") as f:
   57:                                         zf.writestr(f"{name}/{name}{ext}", f.read())
   58:                                 except Exception:
   59:                                     pass
   60:                     st.download_button(
   61:                         "ä¸‹è½½ZIP",
   62:                         data=buf.getvalue(),
   63:                         file_name="models_selected.zip",
   64:                         mime="application/zip",
   65:                     )
   66: 
   67:         st.markdown("---")
   68:         st.write("æ¨¡å‹åˆ—è¡¨ä¸è¯¦æƒ…ï¼š")
   69:         for name in models:
   70:             with st.expander(name, expanded=False):
   71:                 meta = load_model_meta(name)
   72:                 if meta:
   73:                     st.write(f"åˆ›å»ºæ—¶é—´: {meta.get('created_at')}")
   74:                     st.write(f"åˆ†æ®µæ•? {meta.get('n_segments')}  IQRå› å­: {meta.get('iqr_factor')}")
   75:                     bps = meta.get('breakpoints')
   76:                     if bps is not None:
   77:                         st.write(f"æ–­ç‚¹: {np.round(np.array(bps), 4)}")
   78:                     st.write(f"è®­ç»ƒæ•°æ®æ¥æº: {meta.get('source')}")
   79:                 else:
   80:                     st.info("ç¼ºå°‘å…ƒæ•°æ®ï¼ˆmetaï¼‰ï¼Œä»…æä¾›æ¨¡å‹æ–‡ä»¶æ“ä½œã€?)
   81: 
   82:                 c1, c2, c3 = st.columns(3)
   83:                 with c1:
   84:                     try:
   85:                         with open(f"models/{name}.pkl", "rb") as f:
   86:                             st.download_button("ä¸‹è½½æ¨¡å‹(.pkl)", f, file_name=f"{name}.pkl")
   87:                     except Exception:
   88:                         st.warning("æ¨¡å‹æ–‡ä»¶ç¼ºå¤±")
   89:                 with c2:
   90:                     try:
   91:                         with open(f"models/{name}.train.csv", "rb") as f:
   92:                             st.download_button("ä¸‹è½½è®­ç»ƒæ•°æ®", f, file_name=f"{name}.train.csv")
   93:                     except Exception:
   94:                         st.info("æ— è®­ç»ƒæ•°æ®æ–‡ä»?)
   95:                 with c3:
   96:                     if st.button(f"åˆ é™¤ {name}"):
   97:                         delete_models([name])
   98:                         st.success(f"å·²åˆ é™?{name}")
   99: 
  100:                 # è®­ç»ƒæ•°æ®é¢„è§ˆ
  101:                 try:
  102:                     train_df = pd.read_csv(f"models/{name}.train.csv")
  103:                     st.write(f"è®­ç»ƒæ•°æ®è¡Œæ•°: {len(train_df):,}")
  104:                     st.dataframe(train_df.head(10))
  105:                 except Exception:
  106:                     pass
  107: 
  108: 
  109: # ----------------------------------------
  110: # 2) æ¨¡å‹è®­ç»ƒ
  111: # ----------------------------------------
  112: elif MENU == "æ¨¡å‹è®­ç»ƒ":
  113:     st.subheader("æ¨¡å‹è®­ç»ƒ")
  114:     file = st.file_uploader("ä¸Šä¼ è®­ç»ƒç”?Excel æˆ?CSV", type=["xlsx", "csv"])
  115:     model_name = st.text_input("æ¨¡å‹åç§°", value="model_v1").strip()
  116:     n_segments = st.slider("åˆ†æ®µæ•?(pwlf)", min_value=2, max_value=8, value=3)
  117:     iqr_factor = st.slider("IQR å»æå€¼å› å­?, 0.5, 5.0, 1.5, 0.1)
  118: 
  119:     if st.button("è®­ç»ƒæ¨¡å‹"):
  120:         if not file:
  121:             st.warning("è¯·å…ˆä¸Šä¼ è®­ç»ƒæ•°æ®æ–‡ä»¶")
  122:             st.stop()
  123:         if not model_name:
  124:             st.warning("è¯·å¡«å†™æ¨¡å‹åç§?)
  125:             st.stop()
  126:         df = pd.read_excel(file) if file.name.lower().endswith(".xlsx") else pd.read_csv(file)
  127:         try:
  128:             model, breakpoints = train_model_ex(
  129:                 df,
  130:                 model_name=model_name,
  131:                 n_segments=n_segments,
  132:                 iqr_factor=iqr_factor,
  133:                 source=file.name,
  134:             )
  135:             st.success(f"è®­ç»ƒå®Œæˆï¼š{model_name}ï¼Œæ–­ç‚¹ï¼š{np.round(breakpoints, 4)}")
  136:         except Exception as e:
  137:             st.error(f"è®­ç»ƒå¤±è´¥ï¼š{e}")
  138: 
  139: 
  140: # ----------------------------------------
  141: # 3) æ—¥å‰ä»·æ ¼é¢„æµ‹
  142: # ----------------------------------------
  143: elif MENU == "æ—¥å‰ä»·æ ¼é¢„æµ‹":
  144:     st.subheader("æ ¹æ®è´Ÿè·ç‡é¢„æµ‹æ—¥å‰ä»·æ ?)
  145: 
  146:     models = list_models()
  147:     if not models:
  148:         st.warning("æš‚æ— å¯ç”¨æ¨¡å‹ï¼Œè¯·å…ˆåœ¨â€˜æ¨¡å‹è®­ç»ƒâ€™é¡µè®­ç»ƒå¹¶ä¿å­˜æ¨¡å‹ã€?)
  149:         st.stop()
  150:     chosen = st.selectbox("é€‰æ‹©æ¨¡å‹", models)
  151:     model = load_model(chosen)
  152:     if model is None:
  153:         st.error("æ¨¡å‹åŠ è½½å¤±è´¥")
  154:         st.stop()
  155: 
  156:     file = st.file_uploader("ä¸Šä¼ å«è´Ÿè·ç‡åˆ—çš„ CSV/XLSX", type=["csv", "xlsx"])
  157:     x_col = st.text_input("è´Ÿè·ç‡åˆ—åç§°", "load_rate")
  158:     if st.button("é¢„æµ‹") and file:
  159:         df = pd.read_csv(file) if file.name.lower().endswith(".csv") else pd.read_excel(file)
  160:         if x_col not in df.columns:
  161:             st.error(f"æœªæ‰¾åˆ°åˆ—ï¼?{x_col}'")
  162:             st.stop()
  163:         preds = predict_price(model, df[x_col].values)
  164:         out_df = df.copy()
  165:         out_df["predicted_price"] = preds
  166:         st.dataframe(out_df.head())
  167:         st.download_button(
  168:             "ä¸‹è½½é¢„æµ‹ç»“æœ",
  169:             out_df.to_csv(index=False).encode(),
  170:             file_name="price_predictions.csv",
  171:         )
  172:         chart_df = pd.DataFrame({
  173:             "time_slot": np.arange(1, len(preds) + 1),
  174:             "price": preds,
  175:         })
  176:         st.line_chart(chart_df.set_index("time_slot"), height=300)
  177: 
  178: 
  179: # ----------------------------------------
  180: # 4) æ•°æ®å±•ç¤º
  181: # ----------------------------------------
  182: elif MENU == "æ•°æ®å±•ç¤º":
  183:     st.subheader("CSV æ•°æ®å±•ç¤ºä¸ç­›é€?)
  184: 
  185:     if DATA_PATH.exists():
  186:         st.info("æ•°æ®æ¥æº: data/marginal.csv")
  187:         original_df = pd.read_csv(DATA_PATH)
  188:     else:
  189:         st.warning("æœªæ‰¾åˆ°æ•°æ®æ–‡ä»?data/marginal.csv")
  190:         st.stop()
  191: 
  192:     if original_df.empty:
  193:         st.warning("æ•°æ®æ–‡ä»¶ä¸ºç©º")
  194:         st.stop()
  195: 
  196:     st.write(f"æ•°æ®æ€»è¡Œæ•? {len(original_df):,}")
  197:     st.write(f"æ•°æ®åˆ—æ•°: {len(original_df.columns)}")
  198: 
  199:     st.subheader("ç­›é€‰æ¡ä»?)
  200:     col1, col2, col3 = st.columns(3)
  201: 
  202:     with col1:
  203:         st.write("æ—¶é—´ç­›é€?)
  204:         date_columns = [c for c in original_df.columns if ('date' in c.lower()) or ('æ—¥æœŸ' in c) or ('æ—¶é—´' in c)]
  205:         date_filter_enabled = False
  206:         start_date = end_date = None
  207:         date_col = None
  208:         if date_columns:
  209:             date_col = st.selectbox("é€‰æ‹©æ—¥æœŸåˆ?, date_columns)
  210:             try:
  211:                 temp_df = original_df.copy()
  212:                 temp_df[date_col] = pd.to_datetime(temp_df[date_col])
  213:                 min_date = temp_df[date_col].min().date()
  214:                 max_date = temp_df[date_col].max().date()
  215:                 start_date = st.date_input("å¼€å§‹æ—¥æœ?, min_date, min_value=min_date, max_value=max_date)
  216:                 end_date = st.date_input("ç»“æŸæ—¥æœŸ", max_date, min_value=min_date, max_value=max_date)
  217:                 date_filter_enabled = True
  218:             except Exception:
  219:                 st.warning(f"æ— æ³•è§£ææ—¥æœŸåˆ?'{date_col}'")
  220:         else:
  221:             st.info("æœªæ£€æµ‹åˆ°æ—¥æœŸåˆ?)
  222: 
  223:     with col2:
  224:         st.write("æ¡ä»¶ç­›é€?)
  225:         filter_columns = st.multiselect("é€‰æ‹©è¦ç­›é€‰çš„åˆ?, original_df.columns.tolist())
  226:         filters = {}
  227:         for col in filter_columns:
  228:             if original_df[col].dtype in ['object', 'string']:
  229:                 unique_values = original_df[col].dropna().unique().tolist()
  230:                 if len(unique_values) <= 50:
  231:                     selected = st.multiselect(f"ç­›é€?{col}", unique_values, default=unique_values)
  232:                     if selected != unique_values:
  233:                         filters[col] = selected
  234:                 else:
  235:                     text = st.text_input(f"ç­›é€?{col} (åŒ…å«æ–‡æœ¬)")
  236:                     if text:
  237:                         filters[col] = text
  238:             else:
  239:                 try:
  240:                     min_val = float(original_df[col].min())
  241:                     max_val = float(original_df[col].max())
  242:                     if min_val != max_val:
  243:                         rng = st.slider(f"ç­›é€?{col} èŒƒå›´", min_val, max_val, (min_val, max_val))
  244:                         if rng != (min_val, max_val):
  245:                             filters[col] = rng
  246:                 except Exception:
  247:                     pass
  248: 
  249:     with col3:
  250:         st.write("æ‰§è¡Œç­›é€?)
  251:         apply_filter = st.button("æ‰§è¡Œ")
  252: 
  253:     if apply_filter or 'filtered_df' not in st.session_state:
  254:         df = original_df.copy()
  255:         if date_filter_enabled and date_col:
  256:             try:
  257:                 df[date_col] = pd.to_datetime(df[date_col])
  258:                 mask = (df[date_col].dt.date >= start_date) & (df[date_col].dt.date <= end_date)
  259:                 df = df[mask]
  260:             except Exception:
  261:                 pass
  262:         for col, val in filters.items():
  263:             if isinstance(val, list):
  264:                 if df[col].dtype in ['object', 'string']:
  265:                     df = df[df[col].isin(val)]
  266:             elif isinstance(val, str):
  267:                 df = df[df[col].astype(str).str.contains(val, case=False, na=False)]
  268:             elif isinstance(val, tuple):
  269:                 df = df[(df[col] >= val[0]) & (df[col] <= val[1])]
  270:         st.session_state.filtered_df = df
  271:     else:
  272:         df = st.session_state.filtered_df if 'filtered_df' in st.session_state else original_df
  273: 
  274:     st.subheader("ç­›é€‰ç»“æ?)
  275:     st.write(f"ç­›é€‰åè¡Œæ•°: {len(df):,}")
  276:     display_columns = st.multiselect("é€‰æ‹©è¦æ˜¾ç¤ºçš„åˆ?, df.columns.tolist(), default=df.columns.tolist()[:10])
  277:     display_df = df[display_columns] if display_columns else df
  278: 
  279:     rows_per_page = st.selectbox("æ¯é¡µæ˜¾ç¤ºè¡Œæ•°", [10, 25, 50, 100, 500], index=2)
  280:     if len(display_df) > 0:
  281:         total_pages = (len(display_df) - 1) // rows_per_page + 1
  282:         page = st.selectbox("é¡µç ", range(1, total_pages + 1))
  283:         start_idx = (page - 1) * rows_per_page
  284:         end_idx = start_idx + rows_per_page
  285:         st.dataframe(display_df.iloc[start_idx:end_idx], use_container_width=True)
  286: 
  287:         csv = display_df.to_csv(index=False)
  288:         st.download_button("ä¸‹è½½ç­›é€‰åçš„æ•°æ?, csv, file_name="filtered_data.csv", mime="text/csv")
  289: 
  290:         numeric_cols = display_df.select_dtypes(include=[np.number]).columns
  291:         if len(numeric_cols) > 0:
  292:             st.subheader("æ•°å€¼åˆ—ç»Ÿè®¡")
  293:             st.dataframe(display_df[numeric_cols].describe())
  294: 
  295:             st.subheader("æ•°æ®å¯è§†åŒ?)
  296:             chart_col = st.selectbox("é€‰æ‹©è¦ç»˜åˆ¶çš„æ•°å€¼åˆ—", numeric_cols)
  297:             chart_type = st.selectbox("å›¾è¡¨ç±»å‹", ["æŠ˜çº¿", "æŸ±çŠ¶", "ç›´æ–¹"]) 
  298:             x_axis_col = None
  299:             if 'time_slot' in display_df.columns:
  300:                 x_axis_col = 'time_slot'
  301:             elif date_col and date_col in display_df.columns:
  302:                 x_axis_col = date_col
  303: 
  304:             if chart_type == "æŠ˜çº¿":
  305:                 if x_axis_col:
  306:                     chart_df = display_df[[x_axis_col, chart_col]].copy().dropna()
  307:                     if x_axis_col == date_col:
  308:                         try:
  309:                             chart_df[x_axis_col] = pd.to_datetime(chart_df[x_axis_col])
  310:                         except Exception:
  311:                             pass
  312:                     chart_df = chart_df.sort_values(x_axis_col)
  313:                     st.line_chart(chart_df.set_index(x_axis_col))
  314:                 else:
  315:                     chart_df = display_df[chart_col].reset_index()
  316:                     chart_df.columns = ['åºå·', chart_col]
  317:                     st.line_chart(chart_df.set_index('åºå·'))
  318: 
  319:             elif chart_type == "æŸ±çŠ¶":
  320:                 if x_axis_col and len(display_df) <= 100:
  321:                     chart_df = display_df[[x_axis_col, chart_col]].copy().dropna()
  322:                     if x_axis_col == date_col:
  323:                         try:
  324:                             chart_df[x_axis_col] = pd.to_datetime(chart_df[x_axis_col])
  325:                         except Exception:
  326:                             pass
  327:                     chart_df = chart_df.sort_values(x_axis_col)
  328:                     st.bar_chart(chart_df.set_index(x_axis_col))
  329:                 else:
  330:                     limited_df = display_df[chart_col].head(50).reset_index()
  331:                     limited_df.columns = ['åºå·', chart_col]
  332:                     st.bar_chart(limited_df.set_index('åºå·'))
  333: 
  334:             elif chart_type == "ç›´æ–¹":
  335:                 value_counts = display_df[chart_col].value_counts().head(20)
  336:                 st.bar_chart(value_counts)
  337: 
  338: 
  339: # ----------------------------------------
  340: # 5) å…³äº
  341: # ----------------------------------------
  342: else:
  343:     st.markdown(
  344:         """
  345: ### å…³äº
  346: æœ¬åº”ç”¨æä¾›ï¼š
  347: 1. æ¨¡å‹ç®¡ç†ï¼šåˆ é™¤ã€æ‰“åŒ…ä¸‹è½½ã€å¤šé€‰ç®¡ç†ï¼›ç‚¹å‡»æ¨¡å‹å¯æŸ¥çœ‹æ–­ç‚¹ä¸è®­ç»ƒæ•°æ®ã€?2. æ¨¡å‹è®­ç»ƒï¼šä¸Šä¼ Excel/CSVï¼Œè®­ç»ƒå¹¶ä¿å­˜æ¨¡å‹ï¼ˆå¸¦å…ƒæ•°æ®å’Œè®­ç»ƒæ•°æ®ï¼‰ã€?3. æ—¥å‰ä»·æ ¼é¢„æµ‹ï¼šé€‰æ‹©å·²è®­ç»ƒæ¨¡å‹è¿›è¡Œé¢„æµ‹ã€?4. æ•°æ®æµè§ˆä¸ç­›é€‰ï¼šå±•ç¤º data/marginal.csvã€?
  348: åº•å±‚é€»è¾‘è§?model_utils.pyã€?        """
  349:     )
  350: 
